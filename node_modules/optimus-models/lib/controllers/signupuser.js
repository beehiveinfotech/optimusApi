'use strict'
module.exports.signupuser = (req, res, next) => {
   let options = req.headers.options
      , db = options.db
      , firstname = req.body.firstname
      , lastname = req.body.lastname
      , emailaddress = req.body.emailaddress
      , pwd = req.body.pwd
      , mobilenumber = req.body.mobilenumber
      , refcode = req.body.refcode
      , emailconfig = require('../../../../config/emailsend.js')
      , response = {
         'success': false,
         'message': ''

      }
   console.log('The body is', req.body)

   let _sendOTPEmail = (emailaddress_val,notificationtype) => {
      return new Promise((resolve, reject) => {       
          db.query('select get_email_template($1,$2)',[emailaddress_val,notificationtype], (err, result) => {
              if (err) {
                  console.log('Error',err)
                  reject(null)
              } else {               
                  resolve(result)
              }
          })
      })
   }

   return new Promise((resolve, reject) => {

      db.query('select get_user_signup($1,$2,$3,$4,$5,$6)', [firstname, lastname, emailaddress, pwd, mobilenumber, refcode], (err, result) => {
         if (err) {
            console.log('The Error', err)
            response['success'] = false
            response['message'] = 'Error in Operation'
            return reject(response)

         } else {
           
            if (result.rows[0].get_user_signup[0].emailid == '' || result.rows[0].get_user_signup[0].email_otp == '') {
               response['success'] = false
            } else {
               response['success'] = true
 	      _sendOTPEmail(emailaddress,'OTPEmail').then(result=>{
               if(!result){
                  console.log('Email Not Send')
               }else{
                   console.log('the row value',result.rows[0].get_email_template[0])
                   emailconfig(emailaddress, result.rows[0].get_email_template[0].emailsubject, result.rows[0].get_email_template[0].emailbody)
               }
            })
           
            }

           
            response['message'] = result.rows[0].get_user_signup[0].msg
            response['data'] = result.rows[0].get_user_signup[0]
            return resolve(response)

         }

      })
   }).then(response => {
      res.status(200).json(response)
   }).catch(error => {
      res.status(200).json(response)
   })

}